name: Bug Bounty Reconnaissance Automation

on:
  workflow_dispatch:
    inputs:
      target_domain:
        description: 'Target domain for bug bounty reconnaissance (e.g., example.com)'
        required: true
        type: string
      deep_scan:
        description: 'Enable deep scanning (slower but more comprehensive)'
        required: false
        default: false
        type: boolean
      enable_subdomain_bruteforce:
        description: 'Enable subdomain bruteforcing (can be slow)'
        required: false
        default: true
        type: boolean
      report_format:
        description: 'Report format'
        required: false
        default: 'markdown'
        type: choice
        options:
          - markdown
          - json
          - html

permissions:
  contents: write
  actions: write

env:
  PYTHON_VERSION: '3.11'

jobs:
  bug-bounty-recon:
    name: Comprehensive Bug Bounty Reconnaissance
    runs-on: ubuntu-latest
    env:
      TARGET_DOMAIN: ${{ github.event.inputs.target_domain }}
      DEEP_SCAN: ${{ github.event.inputs.deep_scan }}
      ENABLE_SUBDOMAIN_BRUTEFORCE: ${{ github.event.inputs.enable_subdomain_bruteforce }}
      REPORT_FORMAT: ${{ github.event.inputs.report_format }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install reconnaissance dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Install additional tools for bug bounty
          pip install pyasn aiohttp httpx

      - name: Install dnsx
        run: |
          go install -v github.com/projectdiscovery/dnsx/cmd/dnsx@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Install system security tools
        run: |
          # Install essential security tools
          sudo apt-get update
          sudo apt-get install -y \
            dnsutils \
            whois \
            nmap \
            masscan \
            nikto \
            sslscan \
            jq \
            curl \
            wget

      - name: Create output directories
        run: |
          mkdir -p bugbounty_reports/${TARGET_DOMAIN}
          mkdir -p bugbounty_reports/${TARGET_DOMAIN}/subdomains
          mkdir -p bugbounty_reports/${TARGET_DOMAIN}/screenshots
          mkdir -p bugbounty_reports/${TARGET_DOMAIN}/vulnerabilities
          mkdir -p bugbounty_reports/${TARGET_DOMAIN}/assets

      - name: Run DNS Reconnaissance
        id: dns_recon
        run: |
          echo "Starting DNS reconnaissance for ${TARGET_DOMAIN}"
          python dns_recon.py ${TARGET_DOMAIN}

          # Move generated report to bug bounty folder
          if [ -d "reports" ]; then
            cp -r reports/* bugbounty_reports/${TARGET_DOMAIN}/ || true
          fi

      - name: Subdomain Enumeration (Passive + Active)
        id: subdomain_enum
        run: |
          TARGET="${TARGET_DOMAIN}"
          OUTPUT_DIR="bugbounty_reports/${TARGET}/subdomains"

          echo "=== Performing Subdomain Enumeration ==="

          # Method 1: Certificate Transparency logs
          echo "[*] Querying Certificate Transparency logs..."
          curl -s "https://crt.sh/?q=%25.${TARGET}&output=json" | jq -r '.[].name_value' | sort -u > "${OUTPUT_DIR}/crt_subdomains.txt"
          sed 's/\*\.//g' "${OUTPUT_DIR}/crt_subdomains.txt" | sort -u > "${OUTPUT_DIR}/crt_subdomains_clean.txt"

          # Method 2: DNS Aggregator interfaces
          echo "[*] Checking DNS aggregators..."
          curl -s "https://sonar.omnisint.io/subdomains/${TARGET}" | jq -r '.[]' 2>/dev/null | sort -u > "${OUTPUT_DIR}/sonar_subdomains.txt" || echo "Sonar query failed"

          curl -s "https://api.hackertarget.com/hostsearch/?q=${TARGET}" | cut -d',' -f1 | sort -u > "${OUTPUT_DIR}/hackertarget_subdomains.txt" || echo "HackerTarget query failed"

          # Method 3: Search engine enumeration
          echo "[*] Enumerating via search engines..."

          # Merge all passive results
          cat "${OUTPUT_DIR}"/*_subdomains*.txt 2>/dev/null | grep -v "^[[:space:]]*$" | sort -u > "${OUTPUT_DIR}/all_passive_subdomains.txt"

          echo "[+] Found $(wc -l < "${OUTPUT_DIR}/all_passive_subdomains.txt") passive subdomains"

          # Active bruteforcing if enabled
          if [ "${ENABLE_SUBDOMAIN_BRUTEFORCE}" = "true" ]; then
            echo "[*] Performing active subdomain bruteforcing..."

            # Use a basic wordlist for demonstration
            for word in www mail ftp api dev test staging admin portal blog app mobile cdn static media assets; do
              subdomain="${word}.${TARGET}"
              if host -W 2 "${subdomain}" >/dev/null 2>&1; then
                echo "${subdomain}"
              fi
            done > "${OUTPUT_DIR}/bruteforce_subdomains.txt"

            echo "[+] Found $(wc -l < "${OUTPUT_DIR}/bruteforce_subdomains.txt") subdomains via bruteforce"
          fi

          # Merge all subdomains
          cat "${OUTPUT_DIR}"/*_subdomains*.txt 2>/dev/null | grep "\.${TARGET}$" | sort -u > "${OUTPUT_DIR}/all_subdomains_final.txt"

          echo "[âœ“] Total unique subdomains: $(wc -l < "${OUTPUT_DIR}/all_subdomains_final.txt")"

      - name: DNS Resolution and HTTP Probing
        id: http_probe
        run: |
          TARGET="${TARGET_DOMAIN}"
          OUTPUT_DIR="bugbounty_reports/${TARGET}"

          echo "=== Resolving Subdomains and Probing HTTP ==="

          # Resolve subdomains and get IP addresses
          echo "[*] Resolving discovered subdomains..."

          INPUT_FILE="${OUTPUT_DIR}/subdomains/all_subdomains_final.txt"
          OUTPUT_FILE="${OUTPUT_DIR}/subdomains/resolved_subdomains.txt"

          if [ -f "$INPUT_FILE" ]; then
            while IFS= read -r subdomain; do
              if [ -n "$subdomain" ]; then
                # Get IP address
                ip=$(host -W 2 -t A "$subdomain" 2>/dev/null | grep "has address" | head -n1 | awk '{print $4}')
                if [ -n "$ip" ]; then
                  # Check for HTTP/HTTPS
                  http_code=$(curl -k -s -o /dev/null -w "%{http_code}" --max-time 5 "http://${subdomain}" 2>/dev/null || echo "000")
                  https_code=$(curl -k -s -o /dev/null -w "%{http_code}" --max-time 5 "https://${subdomain}" 2>/dev/null || echo "000")

                  echo "${subdomain},${ip},HTTP:${http_code},HTTPS:${https_code}"
                fi
              fi
            done < "$INPUT_FILE" > "$OUTPUT_FILE"
          fi

          echo "[âœ“] Resolved $(wc -l < "$OUTPUT_FILE") subdomains"

          # Extract alive domains
          grep -E "HTTP:(200|301|302|403|401|500)|HTTPS:(200|301|302|403|401|500)" "$OUTPUT_FILE" | cut -d',' -f1 > "${OUTPUT_DIR}/subdomains/alive_subdomains.txt"

          echo "[+] Found $(wc -l < "${OUTPUT_DIR}/subdomains/alive_subdomains.txt") alive domains"

      - name: Technology Stack Fingerprinting
        id: tech_fingerprint
        run: |
          TARGET="${TARGET_DOMAIN}"
          OUTPUT_DIR="bugbounty_reports/${TARGET}"

          echo "=== Fingerprinting Technology Stacks ==="

          ALIVE_FILE="${OUTPUT_DIR}/subdomains/alive_subdomains.txt"
          TECH_FILE="${OUTPUT_DIR}/subdomains/technologies.txt"

          if [ -f "$ALIVE_FILE" ]; then
            while IFS= read -r domain; do
              if [ -n "$domain" ]; then
                echo "[*] Scanning $domain"

                # Get HTTP headers
                headers=$(curl -k -s -I --max-time 5 "https://${domain}" 2>/dev/null || curl -k -s -I --max-time 5 "http://${domain}" 2>/dev/null || echo "")

                # Extract technology information from headers
                server=$(echo "$headers" | grep -i "^Server:" | cut -d':' -f2- | xargs)
                powered_by=$(echo "$headers" | grep -i "^X-Powered-By:" | cut -d':' -f2- | xargs)

                # Get page content for further analysis
                content=$(curl -k -s --max-time 5 "https://${domain}" 2>/dev/null || curl -k -s --max-time 5 "http://${domain}" 2>/dev/null || echo "")

                # Detect common technologies
                tech_found=""

                # Check for common frameworks/CMS
                if echo "$content" | grep -qi "wordpress"; then
                  tech_found="${tech_found} WordPress"
                fi
                if echo "$content" | grep -qi "drupal"; then
                  tech_found="${tech_found} Drupal"
                fi
                if echo "$content" | grep -qi "joomla"; then
                  tech_found="${tech_found} Joomla"
                fi
                if echo "$content" | grep -qi "react\|_next\|__next"; then
                  tech_found="${tech_found} React"
                fi
                if echo "$content" | grep -qi "vue\|vue-app"; then
                  tech_found="${tech_found} Vue.js"
                fi
                if echo "$content" | grep -qi "angular"; then
                  tech_found="${tech_found} Angular"
                fi
                if echo "$content" | grep -qi "jquery"; then
                  tech_found="${tech_found} jQuery"
                fi

                echo "${domain} | Server: ${server:-Unknown} | Powered-By: ${powered_by:-None} | Technologies: ${tech_found:-None detected}"

              fi
            done < "$ALIVE_FILE" > "$TECH_FILE"
          fi

          echo "[âœ“] Technology fingerprinting complete"

      - name: Security Header Analysis
        id: security_headers
        run: |
          TARGET="${TARGET_DOMAIN}"
          OUTPUT_DIR="bugbounty_reports/${TARGET}/vulnerabilities"

          echo "=== Analyzing Security Headers ==="

          ALIVE_FILE="${OUTPUT_DIR}/../subdomains/alive_subdomains.txt"
          SECURITY_REPORT="${OUTPUT_DIR}/security_headers_analysis.txt"

          echo "Security Header Analysis Report" > "$SECURITY_REPORT"
          echo "Generated: $(date)" >> "$SECURITY_REPORT"
          echo "=====================================" >> "$SECURITY_REPORT"
          echo "" >> "$SECURITY_REPORT"

          if [ -f "$ALIVE_FILE" ]; then
            while IFS= read -r domain; do
              if [ -n "$domain" ]; then
                echo "Checking: $domain"
                echo "### $domain ###" >> "$SECURITY_REPORT"

                # Get headers
                headers=$(curl -k -s -I --max-time 5 "https://${domain}" 2>/dev/null || curl -k -s -I --max-time 5 "http://${domain}" 2>/dev/null || echo "")

                # Check security headers
                if echo "$headers" | grep -qi "Strict-Transport-Security"; then
                  echo "[âœ“] HSTS: Present" >> "$SECURITY_REPORT"
                else
                  echo "[âœ—] HSTS: Missing" >> "$SECURITY_REPORT"
                fi

                if echo "$headers" | grep -qi "X-Frame-Options"; then
                  echo "[âœ“] X-Frame-Options: Present" >> "$SECURITY_REPORT"
                else
                  echo "[âœ—] X-Frame-Options: Missing" >> "$SECURITY_REPORT"
                fi

                if echo "$headers" | grep -qi "X-Content-Type-Options"; then
                  echo "[âœ“] X-Content-Type-Options: Present" >> "$SECURITY_REPORT"
                else
                  echo "[âœ—] X-Content-Type-Options: Missing" >> "$SECURITY_REPORT"
                fi

                if echo "$headers" | grep -qi "Content-Security-Policy"; then
                  echo "[âœ“] CSP: Present" >> "$SECURITY_REPORT"
                else
                  echo "[âœ—] CSP: Missing" >> "$SECURITY_REPORT"
                fi

                if echo "$headers" | grep -qi "X-XSS-Protection"; then
                  echo "[âœ“] X-XSS-Protection: Present" >> "$SECURITY_REPORT"
                else
                  echo "[âœ—] X-XSS-Protection: Missing" >> "$SECURITY_REPORT"
                fi

                if echo "$headers" | grep -qi "Referrer-Policy"; then
                  echo "[âœ“] Referrer-Policy: Present" >> "$SECURITY_REPORT"
                else
                  echo "[âœ—] Referrer-Policy: Missing" >> "$SECURITY_REPORT"
                fi

                if echo "$headers" | grep -qi "Permissions-Policy"; then
                  echo "[âœ“] Permissions-Policy: Present" >> "$SECURITY_REPORT"
                else
                  echo "[âœ—] Permissions-Policy: Missing" >> "$SECURITY_REPORT"
                fi

                echo "" >> "$SECURITY_REPORT"

              fi
            done < "$ALIVE_FILE"
          fi

          echo "[âœ“] Security header analysis complete"

      - name: Port Scanning (Quick Top Ports)
        id: port_scan
        if: env.DEEP_SCAN == 'true'
        run: |
          TARGET="${TARGET_DOMAIN}"
          OUTPUT_DIR="bugbounty_reports/${TARGET}/vulnerabilities"

          echo "=== Performing Port Scanning ==="
          echo "[*] Scanning common ports on main domain..."

          # Get main IP
          MAIN_IP=$(host -W 2 -t A "${TARGET}" | grep "has address" | head -n1 | awk '{print $4}')

          if [ -n "$MAIN_IP" ]; then
            echo "[*] Target IP: $MAIN_IP"

            # Quick scan of top 100 ports
            nmap -T4 --top-ports 100 -oN "${OUTPUT_DIR}/nmap_top100.txt" "${MAIN_IP}" 2>/dev/null || true

            # Extract open ports
            grep "open" "${OUTPUT_DIR}/nmap_top100.txt" | head -20 > "${OUTPUT_DIR}/open_ports_summary.txt"

            echo "[âœ“] Port scanning complete"
          else
            echo "[!] Could not resolve target domain IP"
          fi

      - name: SSL/TLS Analysis
        id: ssl_analysis
        run: |
          TARGET="${TARGET_DOMAIN}"
          OUTPUT_DIR="bugbounty_reports/${TARGET}/vulnerabilities"

          echo "=== SSL/TLS Certificate Analysis ==="

          ALIVE_FILE="${OUTPUT_DIR}/../subdomains/alive_subdomains.txt"
          SSL_REPORT="${OUTPUT_DIR}/ssl_analysis.txt"

          echo "SSL/TLS Analysis Report" > "$SSL_REPORT"
          echo "Generated: $(date)" >> "$SSL_REPORT"
          echo "=============================" >> "$SSL_REPORT"
          echo "" >> "$SSL_REPORT"

          if [ -f "$ALIVE_FILE" ]; then
            while IFS= read -r domain; do
              if [ -n "$domain" ]; then
                echo "[*] Checking SSL for $domain"

                echo "### $domain ###" >> "$SSL_REPORT"

                # Run sslscan
                sslscan --no-colour "$domain" 2>/dev/null | head -50 >> "$SSL_REPORT" || echo "[!] SSL scan failed for $domain" >> "$SSL_REPORT"

                echo "" >> "$SSL_REPORT"

              fi
            done < "$ALIVE_FILE"
          fi

          echo "[âœ“] SSL/TLS analysis complete"

      - name: Generate Bug Bounty Report
        id: generate_report
        env:
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          chmod +x generate_report.sh
          ./generate_report.sh

      - name: Upload Bug Bounty Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: bug-bounty-report-${TARGET_DOMAIN}-${{ github.run_id }}
          path: bugbounty_reports/${TARGET_DOMAIN}/
          retention-days: 30

      - name: Commit and push bug bounty report
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Add all bug bounty reports
          git add bugbounty_reports/ || true

          # Create commit with detailed message
          git commit -m "Add comprehensive bug bounty reconnaissance report for ${TARGET_DOMAIN}" || echo "No changes to commit"

          git push || echo "No changes to push"

      - name: Create summary comment
        run: |
          echo "## ðŸŽ¯ Bug Bounty Reconnaissance Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target Domain:** \`${TARGET_DOMAIN}\`" >> $GITHUB_STEP_SUMMARY
          if [ "${DEEP_SCAN}" = "true" ]; then
            echo "**Scan Type:** ðŸ” Deep Scan" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Scan Type:** âš¡ Standard Scan" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Quick Stats" >> $GITHUB_STEP_SUMMARY
          echo "- Report generated and uploaded as artifact" >> $GITHUB_STEP_SUMMARY
          echo "- All data saved to \`bugbounty_reports/${TARGET_DOMAIN}/\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Download the complete bug bounty report from the Actions artifacts section." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Contributed by: @shubham21155102*" >> $GITHUB_STEP_SUMMARY
